# 对话角色改造说明

## 改造概述

将系统对话模式从 **"管制员→应急Agent"** 改为 **"机坪管制Agent→机务人员"**

---

## 一、角色变化对比

### 修改前

```
┌─────────────┐          ┌──────────────────┐
│   管制员    │  ────→   │  应急响应Agent   │
│  (用户)     │          │   (系统)         │
└─────────────┘          └──────────────────┘

对话示例：
  管制员：501机位发现燃油泄漏，发动机运转中
  Agent：好的，我了解了。请问泄漏面积多大？
  管制员：大概2平米
  Agent：收到，我会立即评估风险
```

### 修改后

```
┌──────────────────┐          ┌─────────────┐
│ 机坪管制Agent    │  ────→   │  机务人员   │
│   (系统)         │          │   (用户)    │
└──────────────────┘          └─────────────┘

对话示例：
  机务：这里是机务，501机位发现漏油
  机坪管制：报告你机号
  机务：CA1521
  机坪管制：什么油？燃油、液压油还是滑油？
  机务：燃油
  机坪管制：发动机状态？
  机务：还在转
  机坪管制：收到！高风险，立即通知消防！
```

---

## 二、修改内容详解

### 1️⃣ 场景配置修改 (`scenarios/oil_spill/prompt.yaml`)

#### System Prompt 变化

**修改前：**
```yaml
system_prompt: |
  你是机场机坪应急响应专家 Agent。你的任务是处理机坪特情事件...

  ## 核心原则
  1. 安全第一：高危情况必须立即响应
  2. 信息完整：按 Checklist 收集必要信息
```

**修改后：**
```yaml
system_prompt: |
  你是机场机坪管制员 Agent，负责处理机坪特情事件。
  当收到机务人员的初步报告后，你需要主动向机务询问详细信息...

  ## 你的身份与职责
  - **角色**：机坪管制员（Apron Controller）
  - **对话对象**：现场机务人员
  - **任务**：通过专业询问收集信息，评估风险，协调资源

  ## 对话风格要求
  - 使用专业但友好的口吻
  - 提问简洁明确，避免冗长
  - 示例："报告你机号"、"发动机当前状态？"、"泄漏持续吗？"
  - 不要使用"请问"、"麻烦您"等过于客气的用语
```

#### 询问提示 (ask_prompts) 变化

| 字段 | 修改前 | 修改后 |
|------|-------|--------|
| flight_no | "请提供涉事飞机的航班号（例：CA1521）？" | "报告你机号" |
| position | "请报告事件发生的具体位置（停机位号、滑行道或跑道）？" | "具体位置？停机位还是滑行道？" |
| fluid_type | "请确认泄漏的油液类型（例如：航空燃油、液压油、润滑油）？" | "什么油？燃油、液压油还是滑油？" |
| engine_status | "请确认发动机状态是关车、慢车还是运转？" | "发动机当前状态？运转还是关车？" |
| continuous | "泄漏是否持续？" | "还在漏吗？持续滴漏还是已经停了？" |
| leak_size | "请描述泄漏面积（大面积/中等/小面积或具体面积）？" | "目测面积多大？大概几平米？" |

**语气变化特点：**
- ❌ 删除："请"、"麻烦"、"您"等客套用语
- ✅ 使用：直接、专业、简洁的问句
- ✅ 增加：行业术语和常见选项提示

---

### 2️⃣ 工具修改 (`tools/information/ask_for_detail.py`)

**修改前：**
```python
class AskForDetailTool(BaseTool):
    """向用户追问详细信息"""

    name = "ask_for_detail"
    description = """向用户追问缺失的信息。

使用场景:
- Checklist 中有未收集的字段时
- 需要澄清用户描述时"""
```

**修改后：**
```python
class AskForDetailTool(BaseTool):
    """机坪管制员向现场机务人员询问详细信息"""

    name = "ask_for_detail"
    description = """向现场机务询问缺失的信息。

使用场景:
- Checklist 中有未收集的字段时
- 需要向机务确认关键信息时

示例:
- "报告你机号"
- "发动机状态？"
- "还在漏吗？"
"""
```

**关键变化：**
- `observation` 消息：从 `"已向用户追问"` → `"已向机务询问"`
- 默认问题：从 `"请提供更多信息"` → `"报告详情"`

---

### 3️⃣ 输出生成修改 (`agent/nodes/output_generator.py`)

**修改前：**
```python
prompt = f"""你是一个专业的机场机坪应急响应调度员，
擅长生成标准化的机坪特情处置检查单。
```

**修改后：**
```python
prompt = f"""你是机场机坪管制员，负责记录和汇总机坪特情处置过程。
你已通过与现场机务的对话完成信息收集，现在需要生成标准化的处置检查单。
```

**作用：**
- 在生成最终报告时，明确角色定位
- 强调信息来源于与机务的对话

---

## 三、完整对话流程示例

### 场景：501机位燃油泄漏

```
┌────────────────────────────────────────────────────────────┐
│  第1轮：初次报告                                            │
└────────────────────────────────────────────────────────────┘

【机务】：这里是机务，501机位发现漏油

【系统】：input_parser 提取实体 → position: "501"
        reasoning 决定 → 需要收集航班号

【机坪管制】：报告你机号

┌────────────────────────────────────────────────────────────┐
│  第2轮：收集航班号                                          │
└────────────────────────────────────────────────────────────┘

【机务】：CA1521

【系统】：input_parser 提取 → flight_no: "CA1521"
        checklist 更新 → {flight_no: true}
        reasoning 决定 → 下一个是位置（但已有）→ 询问油液类型

【机坪管制】：什么油？燃油、液压油还是滑油？

┌────────────────────────────────────────────────────────────┐
│  第3轮：收集油液类型                                         │
└────────────────────────────────────────────────────────────┘

【机务】：航空燃油

【系统】：input_parser 提取 → fluid_type: "FUEL"
        checklist 更新 → {fluid_type: true}

【机坪管制】：发动机当前状态？运转还是关车？

┌────────────────────────────────────────────────────────────┐
│  第4轮：收集发动机状态                                       │
└────────────────────────────────────────────────────────────┘

【机务】：发动机还在转

【系统】：input_parser 提取 → engine_status: "RUNNING"
        checklist 更新 → {engine_status: true}

【机坪管制】：还在漏吗？持续滴漏还是已经停了？

┌────────────────────────────────────────────────────────────┐
│  第5轮：收集持续性                                          │
└────────────────────────────────────────────────────────────┘

【机务】：持续的，还在漏

【系统】：input_parser 提取 → continuous: true
        P1字段已齐 → 触发 assess_risk
        risk_assessment → level: "HIGH"
        mandatory_actions → 必须通知消防

【机坪管制】：收到！燃油泄漏+发动机运转=高风险，
            我立即通知消防和塔台，你们现场先设置警戒区，
            禁止任何火源靠近！

【系统】：notify_department → 消防
        notify_department → 塔台

【机坪管制】：目测面积多大？大概几平米？

┌────────────────────────────────────────────────────────────┐
│  第6轮：收集泄漏面积                                         │
└────────────────────────────────────────────────────────────┘

【机务】：大概2平米左右

【系统】：input_parser 提取 → leak_size: "MEDIUM"
        所有字段已收集 → 生成报告

【机坪管制】：好的，信息已记录。消防队正在赶往现场，
            预计3分钟到达。现在给你读一下处置检查单...

            [生成完整的11章节检查单报告]
```

---

## 四、设计理念变化

### 修改前：被动接收模式
- Agent等待用户提供完整信息
- 语气客气、谨慎
- 适合：管制员向系统报告

### 修改后：主动询问模式
- Agent主导信息收集流程
- 语气专业、简洁、直接
- 适合：管制中心调度员与现场人员对话

---

## 五、使用方法

### 1. 测试新对话流程

```bash
# 运行交互式测试
python run_interactive.py

# 输入示例（作为机务人员）：
# "这里是机务，501机位发现漏油"
```

### 2. 预期Agent响应

Agent会主动按顺序询问：
1. 报告你机号
2. 具体位置？
3. 什么油？
4. 发动机状态？
5. 还在漏吗？
6. 目测面积？

### 3. 回答示例（作为机务）

```
机务回答1：CA1521
机务回答2：501机位
机务回答3：燃油
机务回答4：还在转
机务回答5：持续滴漏
机务回答6：大概2平米
```

---

## 六、核心文件修改清单

| 文件路径 | 修改内容 | 状态 |
|---------|---------|------|
| `scenarios/oil_spill/prompt.yaml` | System Prompt + ask_prompts | ✅ 已完成 |
| `tools/information/ask_for_detail.py` | 工具描述 + observation消息 | ✅ 已完成 |
| `agent/nodes/output_generator.py` | 报告生成prompt角色描述 | ✅ 已完成 |

---

## 七、注意事项

### ✅ 保留的部分
- 数据流架构不变
- FSM验证逻辑不变
- 工具调用机制不变
- Checklist顺序规则不变

### 🔄 改变的部分
- 对话角色定位
- 询问语气和措辞
- System Prompt身份描述
- 工具说明文档

### 🎯 改造效果
1. **更贴近实际场景**：机坪管制员就是这样与现场机务对话的
2. **提高交互效率**：简洁专业的问句减少理解成本
3. **增强沉浸感**：用户作为机务人员回答问题更自然
4. **保持功能完整**：所有原有功能（风险评估、FSM验证、报告生成）均不受影响

---

## 八、后续建议

### 可选增强
1. **增加行业术语库**
   - 如："APU"、"推出"、"拖车"等机坪常用术语

2. **紧急情况快速响应**
   - 当机务说"情况紧急"时，Agent优先收集关键信息

3. **多轮确认机制**
   - 对高风险信息（如"发动机运转"）进行二次确认

4. **增加安抚语句**
   - 如："收到，你们做得很好，现在保持现场安全，我们立即协调资源"

---

**改造完成时间**：2026-01-05
**改造作者**：Claude Code
**测试状态**：待运行完整测试
