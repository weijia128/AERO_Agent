# åŸºäºèˆªç­å·çš„åŠ¨æ€æ—¶é—´çª—å£åŠŸèƒ½

## æ¦‚è¿°

æœ¬åŠŸèƒ½å®ç°äº†**åŸºäºå‚è€ƒèˆªç­çš„åŠ¨æ€æ—¶é—´çª—å£è®¡ç®—**ï¼Œè§£å†³äº†ä¹‹å‰ç¡¬ç¼–ç äº‹æ•…æ—¶é—´çš„é—®é¢˜ã€‚ç°åœ¨ç³»ç»Ÿå¯ä»¥ï¼š

1. ä»ç”¨æˆ·æä¾›çš„èˆªç­å·æŸ¥è¯¢çœŸå®èˆªç­è®¡åˆ’æ—¶é—´
2. ä»¥è¯¥èˆªç­æ—¶é—´ä¸ºèµ·ç‚¹ï¼Œç»“åˆ"æ¸…ç†æ—¶é—´ + 30åˆ†é’Ÿ"è®¡ç®—æ—¶é—´çª—å£
3. é¢„æµ‹è¯¥æ—¶é—´çª—å£å†…å—å½±å“çš„ç›¸é‚»èˆªç­

---

## æ”¹è¿›å‰åå¯¹æ¯”

### æ”¹è¿›å‰ï¼ˆç¡¬ç¼–ç æ—¶é—´ï¼‰

```python
# é—®é¢˜ï¼šå§‹ç»ˆä½¿ç”¨å›ºå®šæ—¶é—´ 2026-01-06 10:00
current_time = datetime.fromisoformat("2026-01-06 10:00:00")
end_time = current_time + timedelta(hours=time_window_hours)
```

**ç¼ºç‚¹ï¼š**
- æ—¶é—´çª—å£ä¸å®é™…èˆªç­æ— å…³
- æ— æ³•åˆ†æç‰¹å®šèˆªç­å‘¨è¾¹çš„å½±å“
- ç”¨æˆ·ä½“éªŒå·®ï¼Œéœ€è¦æ‰‹åŠ¨æŒ‡å®šæ—¶é—´

---

### æ”¹è¿›åï¼ˆåŠ¨æ€æ—¶é—´çª—å£ï¼‰

```python
# ä¼˜å…ˆçº§1ï¼šä»å‚è€ƒèˆªç­è·å–æ—¶é—´
reference_flight = state.get("reference_flight", {})
current_time = reference_flight.get("reference_time")

# ä¼˜å…ˆçº§2ï¼šä»äº‹æ•…ä¿¡æ¯è·å–æ—¶é—´
if not current_time:
    current_time = incident.get("incident_time")

# ä¼˜å…ˆçº§3ï¼šä½¿ç”¨é»˜è®¤æ—¶é—´ï¼ˆå‘åå…¼å®¹ï¼‰
if not current_time:
    current_time = "2026-01-06 10:00:00"
```

**ä¼˜ç‚¹ï¼š**
- âœ… è‡ªåŠ¨ä»èˆªç­å·æŸ¥è¯¢æ—¶é—´
- âœ… åˆ†æç‰¹å®šèˆªç­å‘¨è¾¹çš„å®é™…å½±å“
- âœ… ä¿æŒå‘åå…¼å®¹æ€§
- âœ… ç”¨æˆ·ä½“éªŒæ›´è‡ªç„¶

---

## å·¥ä½œæµç¨‹

### æ ‡å‡†æµç¨‹ï¼ˆæœ‰å‚è€ƒèˆªç­ï¼‰

```
ç”¨æˆ·è¾“å…¥: "CES2876èˆªç­åœ¨501æœºä½å‘ç°ç‡ƒæ²¹æ³„æ¼"
    â†“
1. Agentè¯†åˆ«èˆªç­å· â†’ CES2876
    â†“
2. è°ƒç”¨ flight_plan_lookup å·¥å…·
   â†’ æŸ¥è¯¢æ•°æ®: Flight_Plan_2026-01-06_08-12.txt
   â†’ æ‰¾åˆ°: CES2876, èµ·é£æ—¶é—´ 2026-01-06 08:35:00
   â†’ å†™å…¥ state.reference_flight
    â†“
3. è°ƒç”¨ calculate_impact_zone å·¥å…·
   â†’ è®¡ç®—ç©ºé—´å½±å“èŒƒå›´
    â†“
4. è°ƒç”¨ predict_flight_impact å·¥å…·
   â†’ è¯»å– state.reference_flight.reference_time = "2026-01-06 08:35:00"
   â†’ è®¡ç®—æ—¶é—´çª—å£: 08:35 + (æ¸…ç†æ—¶é—´60åˆ†é’Ÿ + 30åˆ†é’Ÿç¼“å†²) = 10:05
   â†’ ç­›é€‰çª—å£å†…èˆªç­: 08:35 - 10:05
   â†’ åˆ†æå»¶è¯¯å½±å“
    â†“
5. ç”ŸæˆæŠ¥å‘Š
   â†’ æ˜¾ç¤ºå‚è€ƒèˆªç­: CES2876
   â†’ æ˜¾ç¤ºæ—¶é—´çª—å£: 08:35 - 10:05
   â†’ åˆ—å‡ºå—å½±å“èˆªç­
```

---

### å‘åå…¼å®¹æµç¨‹ï¼ˆæ— å‚è€ƒèˆªç­ï¼‰

```
ç”¨æˆ·è¾“å…¥: "501æœºä½å‘ç°ç‡ƒæ²¹æ³„æ¼ï¼Œæ—¶é—´æ˜¯11:00"
    â†“
1. Agentè¯†åˆ«äº‹æ•…æ—¶é—´ â†’ 2026-01-06 11:00:00
   â†’ å†™å…¥ state.incident.incident_time
    â†“
2. è°ƒç”¨ predict_flight_impact å·¥å…·
   â†’ state.reference_flight ä¸å­˜åœ¨
   â†’ å›é€€åˆ° incident.incident_time = "2026-01-06 11:00:00"
   â†’ è®¡ç®—æ—¶é—´çª—å£: 11:00 - 12:00
    â†“
3. ç”ŸæˆæŠ¥å‘Šï¼ˆä¸æ˜¾ç¤ºå‚è€ƒèˆªç­ï¼‰
```

---

## æ ¸å¿ƒå®ç°

### 1. flight_plan_lookup å·¥å…·å¢å¼º

**æ–‡ä»¶ä½ç½®:** `tools/information/flight_plan_lookup.py`

**ä¸»è¦æ”¹åŠ¨:**

```python
def execute(self, state: Dict[str, Any], inputs: Dict[str, Any]) -> Dict[str, Any]:
    # ... æŸ¥è¯¢èˆªç­è®¡åˆ’ ...

    # ğŸ†• æå–æ—¶é—´ä¿¡æ¯
    eldt = rec.get("eldt") or rec.get("aldt")  # é¢„è®¡é™è½æ—¶é—´
    etot = rec.get("etot") or rec.get("atot")  # é¢„è®¡èµ·é£æ—¶é—´
    reference_time = etot or eldt              # ä¼˜å…ˆä½¿ç”¨èµ·é£æ—¶é—´

    # ğŸ†• å†™å…¥ state
    state["reference_flight"] = {
        "callsign": flight_no,
        "stand": stand,
        "runway": runway,
        "eldt": eldt,
        "etot": etot,
        "reference_time": reference_time,  # ç”¨äºæ—¶é—´çª—å£è®¡ç®—
    }

    return {
        "observation": f"å·²æŸ¥åˆ°èˆªç­è®¡åˆ’: {flight_no} {inorout}, æœºä½ {stand}, è·‘é“ {runway}, è®¡åˆ’èµ·é£ {etot}",
        "reference_flight": state["reference_flight"],
    }
```

**å…³é”®å­—æ®µ:**
- `reference_time`: ç”¨äºæ—¶é—´çª—å£è®¡ç®—çš„åŸºå‡†æ—¶é—´ï¼ˆä¼˜å…ˆèµ·é£æ—¶é—´ï¼Œæ— åˆ™ç”¨é™è½æ—¶é—´ï¼‰

---

### 2. predict_flight_impact å·¥å…·æ”¹è¿›

**æ–‡ä»¶ä½ç½®:** `tools/spatial/predict_flight_impact.py`

**ä¸»è¦æ”¹åŠ¨:**

```python
def execute(self, state: Dict[str, Any], inputs: Dict[str, Any]) -> Dict[str, Any]:
    # ğŸ†• ä¸‰çº§æ—¶é—´æ¥æºä¼˜å…ˆçº§
    reference_flight = state.get("reference_flight", {})
    incident = state.get("incident", {})

    current_time = None

    # ç¬¬1ä¼˜å…ˆçº§ï¼šå‚è€ƒèˆªç­æ—¶é—´
    if reference_flight:
        reference_time = reference_flight.get("reference_time")
        if reference_time:
            current_time = datetime.fromisoformat(reference_time)

    # ç¬¬2ä¼˜å…ˆçº§ï¼šäº‹æ•…æ—¶é—´
    if current_time is None:
        incident_time = incident.get("incident_time") or incident.get("start_time")
        if incident_time:
            current_time = datetime.fromisoformat(incident_time)

    # ç¬¬3ä¼˜å…ˆçº§ï¼šé»˜è®¤æ—¶é—´ï¼ˆå‘åå…¼å®¹ï¼‰
    if current_time is None:
        current_time = datetime.fromisoformat("2026-01-06 10:00:00")

    # è®¡ç®—æ—¶é—´çª—å£
    end_time = current_time + timedelta(hours=time_window_hours)

    # ... ç­›é€‰èˆªç­ã€è®¡ç®—å»¶è¯¯ ...
```

**ä¼˜å…ˆçº§é€»è¾‘:**
1. ä¼˜å…ˆä½¿ç”¨å‚è€ƒèˆªç­æ—¶é—´ï¼ˆæœ€ç²¾ç¡®ï¼‰
2. æ— å‚è€ƒèˆªç­æ—¶ä½¿ç”¨äº‹æ•…æ—¶é—´ï¼ˆç”¨æˆ·æŒ‡å®šï¼‰
3. æ— ä»»ä½•æ—¶é—´æ—¶ä½¿ç”¨é»˜è®¤æ—¶é—´ï¼ˆå‘åå…¼å®¹ï¼‰

---

### 3. analyze_spill_comprehensive å·¥å…·æ”¹è¿›

**æ–‡ä»¶ä½ç½®:** `tools/assessment/analyze_spill_comprehensive.py`

**ä¸»è¦æ”¹åŠ¨:**

```python
def _generate_comprehensive_observation(self, state, ...):
    # ... ç”ŸæˆæŠ¥å‘Š ...

    # ğŸ†• æ£€æŸ¥æ˜¯å¦åŸºäºå‚è€ƒèˆªç­
    reference_flight = state.get("reference_flight", {})

    if reference_flight and reference_flight.get("callsign"):
        callsign = reference_flight.get("callsign")
        ref_time = reference_flight.get("reference_time", "")
        lines.append(f"  å‚è€ƒèˆªç­: {callsign}")
        if ref_time:
            lines.append(f"  å‚è€ƒæ—¶é—´: {ref_time}")

    # ... ç»§ç»­ç”ŸæˆæŠ¥å‘Š ...
```

**æŠ¥å‘Šç¤ºä¾‹:**

```
ã€èˆªç­å½±å“é¢„æµ‹ã€‘
  å‚è€ƒèˆªç­: CES2876              â† ğŸ†• æ–°å¢
  å‚è€ƒæ—¶é—´: 2026-01-06 08:35:00  â† ğŸ†• æ–°å¢
  åˆ†ææ—¶é—´çª—å£: 08:35 - 10:05
  å—å½±å“èˆªç­: 12 æ¶æ¬¡
  ç´¯è®¡å»¶è¯¯æ—¶é—´: 720 åˆ†é’Ÿ
```

---

## æ•°æ®æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¾“å…¥: "CES2876èˆªç­åœ¨501æœºä½å‘ç°ç‡ƒæ²¹æ³„æ¼"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ flight_plan_lookup.execute()                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ 1. æŸ¥è¯¢æ•°æ®: Flight_Plan_2026-01-06_08-12.txt                â”‚
â”‚ 2. åŒ¹é…èˆªç­: callsign == "CES2876"                           â”‚
â”‚ 3. æå–æ—¶é—´:                                                 â”‚
â”‚    - etot: "2026-01-06 08:35:00"                             â”‚
â”‚    - eldt: "2026-01-06 09:20:00"                             â”‚
â”‚    - reference_time: "2026-01-06 08:35:00" (ä¼˜å…ˆetot)        â”‚
â”‚ 4. å†™å…¥ state.reference_flight                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ calculate_impact_zone.execute()                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ 1. åŸºäºæ‹“æ‰‘å›¾è®¡ç®—ç©ºé—´å½±å“èŒƒå›´                                 â”‚
â”‚ 2. å†™å…¥ state.spatial_analysis                               â”‚
â”‚    - affected_stands: [...]                                  â”‚
â”‚    - affected_runways: [...]                                 â”‚
â”‚    - affected_taxiways: [...]                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ predict_flight_impact.execute()                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ 1. è¯»å–æ—¶é—´æºï¼ˆä¸‰çº§ä¼˜å…ˆçº§ï¼‰:                                  â”‚
â”‚    âœ“ state.reference_flight.reference_time                   â”‚
â”‚      = "2026-01-06 08:35:00"                                 â”‚
â”‚    âœ— state.incident.incident_time (æœªä½¿ç”¨)                   â”‚
â”‚    âœ— é»˜è®¤æ—¶é—´ (æœªä½¿ç”¨)                                       â”‚
â”‚                                                              â”‚
â”‚ 2. è®¡ç®—æ—¶é—´çª—å£:                                             â”‚
â”‚    - æ¸…ç†æ—¶é—´: 60åˆ†é’Ÿ (from cleanup_estimate)                â”‚
â”‚    - ç¼“å†²æ—¶é—´: 30åˆ†é’Ÿ                                        â”‚
â”‚    - çª—å£é•¿åº¦: (60 + 30) / 60 = 1.5å°æ—¶                      â”‚
â”‚    - start_time: 2026-01-06 08:35:00                         â”‚
â”‚    - end_time: 2026-01-06 10:05:00                           â”‚
â”‚                                                              â”‚
â”‚ 3. ç­›é€‰æ—¶é—´çª—å£å†…èˆªç­:                                       â”‚
â”‚    - éå†: Flight_Plan_2026-01-06_08-12.txt                  â”‚
â”‚    - æ¡ä»¶: 08:35 <= (etot OR eldt) <= 10:05                  â”‚
â”‚    - æ‰¾åˆ°: 12æ¶æ¬¡èˆªç­                                        â”‚
â”‚                                                              â”‚
â”‚ 4. åŒ¹é…å—å½±å“èˆªç­:                                           â”‚
â”‚    - æ£€æŸ¥æ¯ä¸ªèˆªç­çš„ stand/runway/taxiway                     â”‚
â”‚    - ä¸ spatial_analysis äº¤å‰åŒ¹é…                            â”‚
â”‚    - åˆ†ç±»: standå½±å“ / runwayå½±å“ / taxiwayå½±å“              â”‚
â”‚                                                              â”‚
â”‚ 5. è®¡ç®—å»¶è¯¯:                                                 â”‚
â”‚    - runwayå½±å“: 60åˆ†é’Ÿ                                      â”‚
â”‚    - standå½±å“: 30-45åˆ†é’Ÿ                                    â”‚
â”‚    - taxiwayå½±å“: 15-20åˆ†é’Ÿ                                  â”‚
â”‚    - æ€»å»¶è¯¯: 720åˆ†é’Ÿ (12æ¶æ¬¡ Ã— å¹³å‡60åˆ†é’Ÿ)                   â”‚
â”‚                                                              â”‚
â”‚ 6. å†™å…¥ state.flight_impact                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ analyze_spill_comprehensive._generate_observation()           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ 1. è¯»å– state.reference_flight                               â”‚
â”‚    - callsign: "CES2876"                                     â”‚
â”‚    - reference_time: "2026-01-06 08:35:00"                   â”‚
â”‚                                                              â”‚
â”‚ 2. ç”ŸæˆæŠ¥å‘Š:                                                 â”‚
â”‚    ã€èˆªç­å½±å“é¢„æµ‹ã€‘                                          â”‚
â”‚      å‚è€ƒèˆªç­: CES2876                                       â”‚
â”‚      å‚è€ƒæ—¶é—´: 2026-01-06 08:35:00                           â”‚
â”‚      åˆ†ææ—¶é—´çª—å£: 08:35 - 10:05                             â”‚
â”‚      å—å½±å“èˆªç­: 12 æ¶æ¬¡                                     â”‚
â”‚      ç´¯è®¡å»¶è¯¯æ—¶é—´: 720 åˆ†é’Ÿ                                  â”‚
â”‚      å¹³å‡å»¶è¯¯: 60.0 åˆ†é’Ÿ/æ¶æ¬¡                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æµ‹è¯•éªŒè¯

**æµ‹è¯•æ–‡ä»¶:** `tests/test_dynamic_time_window.py`

### æµ‹è¯•åœºæ™¯

#### æµ‹è¯•1: flight_plan_lookup æå–æ—¶é—´

```python
# è¾“å…¥: èˆªç­å· CES2876
# æœŸæœ›: state.reference_flight åŒ…å« reference_time

state = {}
result = tool.execute(state, {"flight_no": "CES2876"})

assert "reference_flight" in state
assert state["reference_flight"]["reference_time"] == "2026-01-06 08:35:00"
```

**å®é™…è¾“å‡º:**
```
âœ“ æµ‹è¯•é€šè¿‡ï¼šflight_plan_lookup æˆåŠŸæå–æ—¶é—´å¹¶å†™å…¥ state
  callsign: CES2876
  reference_time: 2026-01-06 08:35:00
```

---

#### æµ‹è¯•2: predict_flight_impact ä½¿ç”¨å‚è€ƒæ—¶é—´

```python
# è¾“å…¥: state åŒ…å« reference_flight
# æœŸæœ›: æ—¶é—´çª—å£èµ·ç‚¹ = reference_time

state = {
    "reference_flight": {"reference_time": "2026-01-06 08:35:00"},
    "spatial_analysis": {...}
}

result = tool.execute(state, {"time_window": 1.5})

assert result["flight_impact"]["time_window"]["start"] == "2026-01-06T08:35:00"
```

**å®é™…è¾“å‡º:**
```
âœ“ æµ‹è¯•é€šè¿‡ï¼špredict_flight_impact æ­£ç¡®ä½¿ç”¨å‚è€ƒèˆªç­æ—¶é—´
  æ—¶é—´çª—å£: 08:35 - 10:05 (1.5å°æ—¶)
  å—å½±å“èˆªç­: 12 æ¶æ¬¡
```

---

#### æµ‹è¯•3: ç»¼åˆåˆ†ææ˜¾ç¤ºå‚è€ƒèˆªç­

```python
# è¾“å…¥: å…ˆæŸ¥è¯¢èˆªç­ï¼Œå†ç»¼åˆåˆ†æ
# æœŸæœ›: æŠ¥å‘Šä¸­åŒ…å«å‚è€ƒèˆªç­ä¿¡æ¯

state = {"incident": {...}, "risk_assessment": {...}}

lookup_tool.execute(state, {"flight_no": "CES2876"})
result = comprehensive_tool.execute(state, {})

assert "å‚è€ƒèˆªç­" in result["observation"]
```

**å®é™…è¾“å‡º:**
```
âœ“ æµ‹è¯•é€šè¿‡ï¼šç»¼åˆåˆ†ææŠ¥å‘Šæ­£ç¡®æ˜¾ç¤ºå‚è€ƒèˆªç­ä¿¡æ¯

ã€èˆªç­å½±å“é¢„æµ‹ã€‘
  å‚è€ƒèˆªç­: CES2876
  å‚è€ƒæ—¶é—´: 2026-01-06 08:35:00
  åˆ†ææ—¶é—´çª—å£: 08:35 - 09:50
  å—å½±å“èˆªç­: 13 æ¶æ¬¡
```

---

#### æµ‹è¯•4: å‘åå…¼å®¹æ€§

```python
# è¾“å…¥: æ— å‚è€ƒèˆªç­ï¼Œä»…æœ‰ incident_time
# æœŸæœ›: ä½¿ç”¨ incident_time

state = {
    "incident": {"incident_time": "2026-01-06 11:00:00"},
    "spatial_analysis": {...}
}

result = tool.execute(state, {"time_window": 1.0})

assert result["flight_impact"]["time_window"]["start"] == "2026-01-06T11:00:00"
```

**å®é™…è¾“å‡º:**
```
âœ“ æµ‹è¯•é€šè¿‡ï¼šå‘åå…¼å®¹æ€§æ­£å¸¸ï¼Œæ— å‚è€ƒèˆªç­æ—¶ä½¿ç”¨ incident_time
  æ—¶é—´çª—å£: 11:00 - 12:00
```

---

### è¿è¡Œæµ‹è¯•

```bash
cd /path/to/AERO_Agent
python tests/test_dynamic_time_window.py
```

**é¢„æœŸè¾“å‡º:**
```
================================================================================
æ‰€æœ‰æµ‹è¯•é€šè¿‡ âœ“
================================================================================
```

---

## ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1: ç”¨æˆ·æä¾›èˆªç­å·

**ç”¨æˆ·è¾“å…¥:**
```
CES2876èˆªç­åœ¨501æœºä½å‘ç°å¤§é¢ç§¯ç‡ƒæ²¹æ³„æ¼
```

**Agentå·¥ä½œæµ:**
```
1. è¯†åˆ«èˆªç­å·: CES2876
2. è°ƒç”¨ flight_plan_lookup("CES2876")
   â†’ æ‰¾åˆ°æ—¶é—´: 2026-01-06 08:35:00
3. è°ƒç”¨ analyze_spill_comprehensive()
   â†’ åŸºäº 08:35 å¼€å§‹åˆ†æ
   â†’ çª—å£: 08:35 - 10:05 (90åˆ†é’Ÿ)
   â†’ æ‰¾åˆ° 12 æ¶å—å½±å“èˆªç­
```

**è¾“å‡ºæŠ¥å‘Š:**
```
ã€èˆªç­å½±å“é¢„æµ‹ã€‘
  å‚è€ƒèˆªç­: CES2876
  å‚è€ƒæ—¶é—´: 2026-01-06 08:35:00
  åˆ†ææ—¶é—´çª—å£: 08:35 - 10:05
  å—å½±å“èˆªç­: 12 æ¶æ¬¡
  ç´¯è®¡å»¶è¯¯æ—¶é—´: 720 åˆ†é’Ÿ

å—å½±å“æœ€ä¸¥é‡çš„èˆªç­ï¼ˆå‰5ï¼‰:
1. CES2231: å»¶è¯¯ 60 åˆ†é’Ÿ (è·‘é“å°é”)
2. CSZ9204: å»¶è¯¯ 60 åˆ†é’Ÿ (è·‘é“å°é”)
3. GCR7693: å»¶è¯¯ 60 åˆ†é’Ÿ (è·‘é“å°é”)
...
```

---

### åœºæ™¯2: ç”¨æˆ·ä»…æä¾›æ—¶é—´ï¼ˆæ— èˆªç­å·ï¼‰

**ç”¨æˆ·è¾“å…¥:**
```
501æœºä½å‘ç°ç‡ƒæ²¹æ³„æ¼ï¼Œæ—¶é—´æ˜¯ä¸Šåˆ11ç‚¹
```

**Agentå·¥ä½œæµ:**
```
1. è¯†åˆ«æ—¶é—´: 2026-01-06 11:00:00
2. å†™å…¥ state.incident.incident_time
3. è°ƒç”¨ analyze_spill_comprehensive()
   â†’ æ— å‚è€ƒèˆªç­ï¼Œä½¿ç”¨ incident_time
   â†’ çª—å£: 11:00 - 12:00
   â†’ æ‰¾åˆ°ç›¸åº”èˆªç­
```

**è¾“å‡ºæŠ¥å‘Š:**
```
ã€èˆªç­å½±å“é¢„æµ‹ã€‘
  åˆ†ææ—¶é—´çª—å£: 11:00 - 12:00
  å—å½±å“èˆªç­: X æ¶æ¬¡
  ...
```

---

## ä¼˜åŠ¿ä¸ä»·å€¼

### 1. æ›´ç²¾ç¡®çš„æ—¶é—´çª—å£

**æ”¹è¿›å‰:**
```
å›ºå®šçª—å£: 10:00 - 12:00
é—®é¢˜: å¯èƒ½é”™è¿‡ 08:00 - 10:00 çš„èˆªç­
```

**æ”¹è¿›å:**
```
åŠ¨æ€çª—å£: åŸºäºå®é™…èˆªç­æ—¶é—´
ä¾‹å¦‚: CES2876 èµ·é£ 08:35
çª—å£: 08:35 - 10:05
è¦†ç›–: è¯¥èˆªç­å‰å 90 åˆ†é’Ÿçš„ç›¸é‚»èˆªç­
```

### 2. æ›´ç¬¦åˆç”¨æˆ·ç›´è§‰

**æ”¹è¿›å‰:**
```
ç”¨æˆ·: "CES2876èˆªç­æ¼æ²¹äº†"
ç³»ç»Ÿ: ï¼ˆå¿½ç•¥èˆªç­å·ï¼Œç”¨é»˜è®¤æ—¶é—´ 10:00ï¼‰
```

**æ”¹è¿›å:**
```
ç”¨æˆ·: "CES2876èˆªç­æ¼æ²¹äº†"
ç³»ç»Ÿ: æŸ¥è¯¢ CES2876 â†’ 08:35 èµ·é£
      åˆ†æ 08:35 å‘¨è¾¹çš„èˆªç­å½±å“
```

### 3. çœŸå®èˆªç­è”åŠ¨åˆ†æ

**æ”¹è¿›å‰:**
```
åˆ†æçª—å£: 10:00 - 12:00
å®é™…èˆªç­: CES2876 åœ¨ 08:35 èµ·é£
é—®é¢˜: æ—¶é—´çª—å£ä¸å®é™…èˆªç­æ— å…³
```

**æ”¹è¿›å:**
```
å‚è€ƒèˆªç­: CES2876, 08:35 èµ·é£
åˆ†æçª—å£: 08:35 - 10:05
ä»·å€¼: ç›´æ¥åˆ†æè¯¥èˆªç­å‘¨è¾¹çš„ç›¸é‚»èˆªç­å½±å“
```

### 4. å‘åå…¼å®¹

**å…¼å®¹æ€§ä¿è¯:**
- âœ… æ”¯æŒæ—§çš„ `incident_time` å­—æ®µ
- âœ… æ— èˆªç­å·æ—¶è‡ªåŠ¨å›é€€åˆ°é»˜è®¤æ—¶é—´
- âœ… ä¸ç ´åç°æœ‰å·¥ä½œæµ

---

## æ³¨æ„äº‹é¡¹

### 1. èˆªç­å·å¿…é¡»åœ¨æ•°æ®é›†ä¸­

**æ•°æ®èŒƒå›´:**
- æ–‡ä»¶: `data/raw/èˆªç­è®¡åˆ’/Flight_Plan_2026-01-06_08-12.txt`
- æ—¶é—´: 2026-01-06 08:00 - 12:00
- èˆªç­æ•°: 576 æ¡è®°å½•

**å¦‚æœèˆªç­å·ä¸å­˜åœ¨:**
```python
result = flight_plan_lookup.execute(state, {"flight_no": "UNKNOWN999"})
# è¿”å›: {"observation": "Log_4 ä¸­æœªæ‰¾åˆ°èˆªç­ UNKNOWN999 çš„è®¡åˆ’è®°å½•"}
# state.reference_flight ä¸ä¼šè¢«å†™å…¥
# åç»­åˆ†æä¼šå›é€€åˆ° incident_time æˆ–é»˜è®¤æ—¶é—´
```

### 2. æ—¶é—´çª—å£è®¡ç®—

**å…¬å¼:**
```
çª—å£é•¿åº¦ = (æ¸…ç†æ—¶é—´ + 30åˆ†é’Ÿç¼“å†²) / 60
èµ·ç‚¹ = reference_time
ç»ˆç‚¹ = reference_time + çª—å£é•¿åº¦
```

**ç¤ºä¾‹:**
```
æ¸…ç†æ—¶é—´: 60åˆ†é’Ÿ
ç¼“å†²æ—¶é—´: 30åˆ†é’Ÿ
çª—å£é•¿åº¦: (60 + 30) / 60 = 1.5 å°æ—¶

reference_time = "2026-01-06 08:35:00"
start_time = 2026-01-06 08:35:00
end_time = 2026-01-06 10:05:00
```

### 3. ä¼˜å…ˆä½¿ç”¨èµ·é£æ—¶é—´

**é€»è¾‘:**
```python
reference_time = etot or eldt
# ä¼˜å…ˆä½¿ç”¨èµ·é£æ—¶é—´ï¼ˆetotï¼‰
# å¦‚æœæ²¡æœ‰èµ·é£æ—¶é—´ï¼Œä½¿ç”¨é™è½æ—¶é—´ï¼ˆeldtï¼‰
```

**åŸå› :**
- èµ·é£æ—¶é—´æ›´é€‚åˆä½œä¸ºäº‹æ•…å‘ç”Ÿæ—¶é—´ç‚¹
- è¦†ç›–èµ·é£å‰åçš„èˆªç­æ›´æœ‰æ„ä¹‰

---

## æ›´æ–°æ—¥å¿—

### v2.0.0 (2026-01-20)

#### æ–°å¢åŠŸèƒ½
- âœ… åŸºäºèˆªç­å·çš„åŠ¨æ€æ—¶é—´çª—å£è®¡ç®—
- âœ… flight_plan_lookup å·¥å…·å¢å¼ºï¼ˆæå–æ—¶é—´å¹¶å†™å…¥ stateï¼‰
- âœ… predict_flight_impact ä¸‰çº§æ—¶é—´æ¥æºä¼˜å…ˆçº§
- âœ… analyze_spill_comprehensive æŠ¥å‘Šæ˜¾ç¤ºå‚è€ƒèˆªç­

#### æµ‹è¯•è¦†ç›–
- âœ… æµ‹è¯•1: flight_plan_lookup æå–æ—¶é—´
- âœ… æµ‹è¯•2: predict_flight_impact ä½¿ç”¨å‚è€ƒæ—¶é—´
- âœ… æµ‹è¯•3: ç»¼åˆåˆ†ææ˜¾ç¤ºå‚è€ƒèˆªç­
- âœ… æµ‹è¯•4: å‘åå…¼å®¹æ€§

#### æ–‡æ¡£æ›´æ–°
- âœ… æ–°å¢: `docs/DYNAMIC_TIME_WINDOW.md`
- âœ… æ›´æ–°: `tools/information/flight_plan_lookup.py`
- âœ… æ›´æ–°: `tools/spatial/predict_flight_impact.py`
- âœ… æ›´æ–°: `tools/assessment/analyze_spill_comprehensive.py`

---

## æœªæ¥æ”¹è¿›æ–¹å‘

### 1. æ”¯æŒå¤šèˆªç­åˆ†æ

**å½“å‰:**
```
å‚è€ƒèˆªç­: CES2876
```

**æœªæ¥:**
```
å‚è€ƒèˆªç­: CES2876, CSZ9204, GCR7693
çª—å£: åˆå¹¶å¤šä¸ªèˆªç­çš„æ—¶é—´èŒƒå›´
```

### 2. æ™ºèƒ½çª—å£è°ƒæ•´

**å½“å‰:**
```
çª—å£é•¿åº¦ = å›ºå®šå…¬å¼ï¼ˆæ¸…ç†æ—¶é—´ + 30åˆ†é’Ÿï¼‰
```

**æœªæ¥:**
```
çª—å£é•¿åº¦ = åŠ¨æ€è°ƒæ•´
- é«˜å³°æ—¶æ®µ: å»¶é•¿çª—å£ï¼ˆ+60åˆ†é’Ÿï¼‰
- ä½è°·æ—¶æ®µ: ç¼©çŸ­çª—å£ï¼ˆ+15åˆ†é’Ÿï¼‰
```

### 3. å†å²æ•°æ®æ‰©å±•

**å½“å‰:**
```
æ•°æ®èŒƒå›´: 2026-01-06 08:00 - 12:00
```

**æœªæ¥:**
```
æ•°æ®èŒƒå›´: å…¨å¤© 24 å°æ—¶ï¼Œå¤šå¤©æ•°æ®
æ”¯æŒä»»æ„æ—¶é—´æ®µçš„èˆªç­æŸ¥è¯¢
```

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚æœç”¨æˆ·åŒæ—¶æä¾›èˆªç­å·å’Œæ—¶é—´æ€ä¹ˆåŠ?

A: ä¼˜å…ˆä½¿ç”¨èˆªç­å·æŸ¥è¯¢çš„æ—¶é—´ï¼Œå¿½ç•¥ç”¨æˆ·æä¾›çš„æ—¶é—´ã€‚

```python
# ç”¨æˆ·è¾“å…¥: "CES2876èˆªç­åœ¨11ç‚¹æ¼æ²¹"
# ç³»ç»Ÿè¡Œä¸º:
# 1. æŸ¥è¯¢ CES2876 â†’ 08:35
# 2. ä½¿ç”¨ 08:35 ä½œä¸ºèµ·ç‚¹ï¼ˆå¿½ç•¥11ç‚¹ï¼‰
```

---

### Q2: èˆªç­å·æŸ¥è¯¢å¤±è´¥æ€ä¹ˆåŠ?

A: è‡ªåŠ¨å›é€€åˆ° `incident_time` æˆ–é»˜è®¤æ—¶é—´ã€‚

```python
# èˆªç­å·ä¸å­˜åœ¨
# â†’ state.reference_flight ä¸ºç©º
# â†’ ä½¿ç”¨ state.incident.incident_time
# â†’ å¦‚æœä¹Ÿæ²¡æœ‰ï¼Œä½¿ç”¨é»˜è®¤æ—¶é—´ 10:00
```

---

### Q3: å¦‚ä½•æ‰©å±•æ—¶é—´æ•°æ®èŒƒå›´?

A: æ·»åŠ æ›´å¤šèˆªç­è®¡åˆ’æ–‡ä»¶ã€‚

```bash
# 1. è§£ææ–°çš„èˆªç­è®¡åˆ’æ•°æ®
cd scripts/data_processing
python parse_efs_flight_plan.py

# 2. ä¿®æ”¹ FlightPlanLookupTool çš„æ–‡ä»¶è·¯å¾„
primary_file = "Flight_Plan_2026-01-07_00-24.txt"  # å…¨å¤©æ•°æ®
```

---

## æ€»ç»“

æœ¬æ¬¡æ”¹è¿›å®ç°äº†**åŸºäºèˆªç­å·çš„åŠ¨æ€æ—¶é—´çª—å£**ï¼Œä¸»è¦ä¼˜åŠ¿ï¼š

1. **æ›´ç²¾ç¡®**: æ—¶é—´çª—å£åŸºäºå®é™…èˆªç­æ—¶é—´
2. **æ›´æ™ºèƒ½**: è‡ªåŠ¨æŸ¥è¯¢èˆªç­æ—¶é—´ï¼Œæ— éœ€ç”¨æˆ·æŒ‡å®š
3. **æ›´è‡ªç„¶**: ç¬¦åˆç”¨æˆ·è¡¨è¾¾ä¹ æƒ¯ï¼ˆ"XXèˆªç­æ¼æ²¹äº†"ï¼‰
4. **å‘åå…¼å®¹**: ä¸ç ´åç°æœ‰åŠŸèƒ½

æ ¸å¿ƒæ”¹åŠ¨ï¼š
- âœ… `flight_plan_lookup.py`: æå–æ—¶é—´å¹¶å†™å…¥ state
- âœ… `predict_flight_impact.py`: ä¸‰çº§æ—¶é—´æ¥æºä¼˜å…ˆçº§
- âœ… `analyze_spill_comprehensive.py`: æŠ¥å‘Šæ˜¾ç¤ºå‚è€ƒèˆªç­
- âœ… `test_dynamic_time_window.py`: å®Œæ•´æµ‹è¯•è¦†ç›–

æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ŒåŠŸèƒ½å·²å¯ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚
