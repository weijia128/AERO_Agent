# 机场应急响应系统 - 报告数据来源分析

## 概述

本系统生成的机坪特情处置检查单报告包含多类数据来源，按照数据获取方式和处理流程，可分为三大类别：**前端获取信息**、**固有信息**和**LLM生成信息**。

---

## 一、前端获取信息（用户输入/对话提取）

### 1.1 定义
通过用户对话/输入，系统使用 `input_parser` 从自然语言中提取的实体信息。这类信息直接来自事件现场报告或操作员输入。

### 1.2 主要字段
| 字段名 | 中文名称 | 获取方式 | 存储位置 | 示例 |
|--------|---------|---------|---------|------|
| `flight_no` | 航班号 | 用户对话提取 | `incident.flight_no` | "南航3456" |
| `position` | 事发位置 | 用户对话提取 | `incident.position` | "501机位" |
| `fluid_type` | 油液类型 | 用户对话提取 | `incident.fluid_type` | "FUEL" |
| `engine_status` | 发动机状态 | 用户对话提取 | `incident.engine_status` | "RUNNING" |
| `continuous` | 是否持续滴漏 | 用户对话提取 | `incident.continuous` | true |
| `leak_size` | 泄漏面积 | 用户对话提取 | `incident.leak_size` | "LARGE" |
| `reported_by` | 报告人 | 用户对话提取 | `incident.reported_by` | "机务小王" |
| `report_time` | 报告时间 | 系统记录 | `incident.report_time` | "2025-01-11 10:30:00" |

### 1.3 处理流程
```
用户对话 → input_parser → 实体提取 → 更新状态
```

### 1.4 报告中的体现位置
- **第1节 事件基本信息**：航班号、发现位置、报告人等
- **第2节 特情初始确认**：油液类型、发动机状态、泄漏面积等
- **第4节 协同单位通知记录**：报告人信息
- **执行轨迹摘要**：部分字段用于上下文

### 1.5 依赖工具
- `agent/nodes/input_parser.py` - 输入解析器
- `tools/information/get_aircraft_info.py` - 航班信息查询（自动触发）

---

## 二、固有信息（系统配置/数据文件/规则引擎）

### 2.1 定义
系统预置的静态数据、配置文件、规则引擎计算结果，以及从外部数据文件读取的信息。这部分信息不依赖LLM生成，具有确定性特征。

### 2.2 分类与来源

#### A. 预配置规则与映射
**来源：**代码中的硬编码映射表

| 内容 | 来源 | 用途 |
|------|------|------|
| 油液类型映射 (`FLUID_TYPE_MAP`) | `output_generator.py:23-27` | 油液类型中文详细名称 |
| 油液类型简洁映射 (`FLUID_TYPE_MAP_SIMPLE`) | `output_generator.py:30-34` | 事件摘要用 |
| 泄漏面积映射 (`LEAK_SIZE_MAP`) | `output_generator.py:37-42` | 面积范围显示 |
| 发动机状态文本 | `output_generator.py:115` | "运行中"/"关闭"转换 |
| 风险等级颜色配置 | `scenarios/oil_spill/prompt.yaml:144-152` | 风险等级定义 |
| 部门联系方式 | `output_generator.py:522-550` | 内部电话 |

**报告应用位置：**
- 油液类型显示：`航空燃油(Jet Fuel)` vs `燃油`
- 泄漏面积显示：`>5㎡` vs `大面积`
- 发动机状态：`运行中`/`关闭`

#### B. 风险评估规则引擎
**来源：** `tools/assessment/assess_risk.py`

| 规则类型 | 数据源 | 确定性计算 | 报告位置 |
|----------|--------|------------|----------|
| 风险等级矩阵 | `RISK_RULES` (12条预置规则) | 规则匹配 | 第1节风险等级 |
| 风险分数 | 规则定义分数 | 确定性计算 | 风险分数显示 |
| 风险因素 | 匹配成功的条件 | 确定性计算 | 风险因素列表 |
| 立即行动建议 | `IMMEDIATE_ACTIONS` | 查表映射 | 第3节初期控制措施 |

**示例规则：**
```python
{
    "conditions": {"fluid_type": "FUEL", "continuous": True, "engine_status": "RUNNING"},
    "level": "HIGH",
    "score": 95,
    "description": "航空燃油+持续泄漏+发动机运转=极高火灾风险"
}
```

#### C. 机场拓扑数据
**来源：** `scripts/data_processing/topology_clustering_based.json`

| 数据项 | 来源文件 | 处理工具 | 报告位置 |
|--------|----------|----------|----------|
| 停机位坐标 | `topology_clustering_based.json` | `topology_loader.py` | 空间分析部分 |
| 滑行道连接关系 | 拓扑图邻接表 | BFS算法 | 第5节区域隔离 |
| 跑道信息 | 拓扑图节点 | 节点类型识别 | 第5节、9节 |
| 影响范围计算 | BFS扩散算法 | `calculate_impact_zone.py` | 第5节、9节 |

**计算规则：**
- **扩散半径：**根据油液类型和风险等级确定BFS跳数
  - 高危燃油：3跳扩散
  - 中危燃油：2跳扩散
  - 低危燃油：1跳扩散
  - 液压油：1-2跳扩散
  - 滑油：0-1跳扩散
- **跑道影响：**高危燃油可能影响跑道（规则配置）

#### D. 航班计划数据
**来源：** `data/raw/航班计划/Log_*.txt`

| 字段 | 数据格式 | 获取方式 | 报告应用 |
|------|----------|----------|----------|
| 航班号 (callsign) | "CES2146" | 文件解析 | 航班号查询、影响评估 |
| 停机位 (stand) | "506" | 文件解析 | 位置交叉验证 |
| 跑道 (runway) | "05L" | 文件解析 | 跑道影响分析 |
| 进出港状态 (inorout) | "A" 或 "D" | 文件解析 | 航班状态判断 |
| 计划时间 | 时间戳 | 文件解析 | 时间相关分析 |

**示例数据：**
```
[2025-10-21 10:31:6:328]{	"inorout":"A",	"aldt":"2025-10-21 02:30:00",	"callsign":"CES2146",	"eldt":"2025-10-21 02:28:00",	"runway":"05L",	"stand":"506"}
```

#### E. 知识库/规程库
**来源：** `tools/knowledge/search_regulations.py`

| 知识类型 | 数据源 | 内容 | 报告位置 |
|----------|--------|------|----------|
| 燃油泄漏规程 | `MOCK_REGULATIONS["fuel_spill"]` | 10步处置流程 | 第6节清污处置 |
| 滑油泄漏规程 | `MOCK_REGULATIONS["engine_oil_spill"]` | 9步处置流程 | 第6节 |
| 液压油规程 | `MOCK_REGULATIONS["hydraulic_spill"]` | 9步处置流程 | 第6节 |
| 清理方式 | 规程中的 `cleanup_method` | 处置方法描述 | 第6节清理方式字段 |
| 历史案例 | `MOCK_CASES` 列表 | 类似事件记录 | 知识参考 |

#### F. FSM状态机配置
**来源：** `agent/state.py`

| 状态项 | 枚举值 | 用途 | 报告位置 |
|--------|--------|------|----------|
| FSM状态 | `INIT → P1_RISK_ASSESS → ... → COMPLETED` | 流程控制 | 执行轨迹摘要 |
| 风险等级枚举 | `HIGH/MEDIUM/LOW/UNKNOWN` | 风险分级 | 风险等级显示 |
| 动作状态 | `PENDING/IN_PROGRESS/COMPLETED/FAILED` | 状态追踪 | 执行记录 |

#### G. 部门通知配置
**来源：** `output_generator.py:62-68`

```python
DEPT_NOTIFICATION_CONFIG = {
    "机务": ("maintenance_notified", ["机务"]),
    "清污/场务": ("cleaning_notified", ["清洗", "清污"]),
    "消防": ("fire_dept_notified", ["消防"]),
    "机场运行指挥": ("operations_notified", ["运控", "运行指挥"]),
    "安全监察": ("safety_notified", ["安全监察"]),
}
```

**用途：**判断哪些部门需要通知、通知状态映射、联系方式显示

---

## 三、LLM生成信息（大语言模型推理）

### 3.1 定义
通过大语言模型（LLM）基于上下文和已知数据生成的文本内容，包括事件总结、处置效果评估、改进建议等。

### 3.2 生成内容

#### A. 事件总结（3个字段）
**调用函数：** `_generate_event_summary_with_llm()`

**输入上下文：**
- 事件基本信息（位置、油液类型、面积等）
- 风险评估结果（等级、分数、因素）
- 空间分析结果（受影响区域）
- 通知记录（已通知单位）
- 检索到的知识（规程参考）

**生成字段：**
1. **event_description（事件经过简述）**
   - 内容：1-2句话概括事件关键信息
   - 特点：语言流畅自然，包含所有关键要素
   - 报告位置：第10节 - 事件经过简述

2. **effect_evaluation（处置效果评估）**
   - 内容：评估当前处置进展和效果
   - 特点：1-2句话，专业客观
   - 报告位置：第10节 - 处置效果评估

3. **improvement_suggestions（后续改进建议）**
   - 内容：3条针对性改进建议
   - 特点：结合具体事件特点，避免笼统表述
   - 报告位置：第10节 - 后续改进建议

**生成Prompt示例：**
```
你是机场机坪应急响应专家，请根据以下事件信息生成专业的事件总结。

## 事件信息
- 航班号：{ctx['flight_no']}
- 发现位置：{ctx['position']}
- 油液类型：{ctx['oil_type']}
- 泄漏面积：{ctx['leak_area']}
- 是否持续滴漏：{ctx['is_continuous_text']}
- 发动机状态：{ctx['engine_status']}
- 风险等级：{ctx['risk_level']}
- 受影响区域：{affected_text}
- 已通知单位：{notified_text}

## 输出要求
请生成事件经过简述、处置效果评估、后续改进建议三部分内容。
```

#### B. LLM触发条件
1. **主要触发：** `output_generator_node` 在生成最终报告时
2. **前置条件：**已有足够的基础数据（事件信息、风险评估、空间分析等）
3. **失败回退：**如果LLM生成失败，使用 `_build_deterministic_summary()` 确定性模板

#### C. 回退方案
**文件：** `output_generator.py:166-211`

当LLM不可用或生成失败时，使用硬编码模板：

```python
event_description = (
    f"{ctx['position']}发生约{ctx['leak_area']}的{ctx['oil_type']}泄漏，"
    f"{continuous_text}，{engine_risk_text}。"
    f"经风险评估，危险等级为{ctx['risk_level']}。"
)
```

---

## 四、数据流向图

```
┌─────────────────┐
│   用户输入/对话   │───► 前端获取信息
└─────────────────┘
         │
         ▼
┌─────────────────┐
│  input_parser   │───► 实体提取
└─────────────────┘
         │
         ▼
┌─────────────────┐        ┌─────────────────┐
│   事件信息状态   │───────►│ 航班数据查询     │───► 固有信息
└─────────────────┘        └─────────────────┘
         │
         ▼                   ┌─────────────────┐
┌─────────────────┐         │ 拓扑数据分析     │───► 固有信息
│  风险评估工具   │───────►│ (BFS算法)       │
└─────────────────┘         └─────────────────┘
         │                   ┌─────────────────┐
         ▼                   │ 规则引擎计算     │───► 固有信息
┌─────────────────┐         │ (确定性)        │
│  空间分析工具   │───────►└─────────────────┘
└─────────────────┘         ┌─────────────────┐
         │                 │ 知识库检索      │───► 固有信息
         ▼                 └─────────────────┘
┌─────────────────┐
│  LLM总结生成    │───► LLM生成信息
└─────────────────┘
         │
         ▼
┌─────────────────┐
│   报告生成      │───► 完整报告
└─────────────────┘
```

---

## 五、报告各节数据来源汇总

| 报告章节 | 前端获取 | 固有信息 | LLM生成 |
|----------|----------|----------|---------|
| 1. 事件基本信息 | ✓ 航班号、位置、报告人、时间 | ✓ 事件编号、风险等级 | |
| 2. 特情初始确认 | ✓ 油液类型、持续性、发动机状态、面积 | ✓ 字段映射显示 | |
| 3. 初期风险控制措施 | | ✓ 风险等级规则驱动显示 | |
| 4. 协同单位通知记录 | | ✓ 部门配置、联系方式、状态映射 | |
| 5. 区域隔离与现场检查 | | ✓ 拓扑BFS计算结果 | |
| 6. 清污处置执行情况 | | ✓ 知识库规程、清理方式 | |
| 7. 处置结果确认 | | ✓ 检查单模板 | |
| 8. 区域恢复与运行返还 | | ✓ 检查单模板 | |
| 9. 运行影响评估 | | ✓ 拓扑分析、航班数据 | |
| 10. 事件总结与改进建议 | | | ✓ 事件描述、效果评估、改进建议 |
| 11. 签字与存档 | | ✓ 模板结构 | |

---

## 六、关键特性

### 6.1 混合设计优势
1. **前端获取信息**：保证数据真实性和时效性
2. **固有信息**：确保计算准确性和可追溯性
3. **LLM生成信息**：提升报告可读性和专业性

### 6.2 数据可靠性
- **确定性数据**：规则引擎、拓扑计算、文件数据 → 100%可靠
- **半确定性数据**：LLM生成（有回退机制）→ 高可靠
- **用户输入数据**：需验证和交叉检查

### 6.3 可扩展性
- **新增场景**：只需添加 `scenarios/<name>/prompt.yaml` 配置文件
- **新增工具**：扩展 `tools/` 目录，遵循 `BaseTool` 规范
- **新数据源**：在相应节点集成数据读取逻辑

---

## 七、总结

本系统采用**混合架构**的设计理念：
- **确定性组件**（规则引擎、图算法）处理精确计算
- **LLM**处理自然语言生成和智能总结
- **前端交互**确保信息获取的灵活性

这种设计既保证了应急响应的专业性和准确性，又通过LLM提升了报告的可读性和实用性。报告的每个字段都有明确的数据来源和获取路径，确保了信息的可追溯性和可靠性。

---

*分析时间：2026-01-11*
*版本：v1.0*
