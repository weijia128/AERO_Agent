# è‡ªåŠ¨æ°”è±¡æŸ¥è¯¢åŠŸèƒ½é›†æˆå®Œæˆ âœ…

## æ¦‚è¿°

æˆåŠŸå®ç°äº†åœ¨Agentç³»ç»Ÿä¸­è‡ªåŠ¨æŸ¥è¯¢æ°”è±¡ä¿¡æ¯çš„åŠŸèƒ½ã€‚å½“ç”¨æˆ·æä¾›ä½ç½®ä¿¡æ¯åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è·å–è¯¥ä½ç½®çš„æœ€æ–°æ°”è±¡æ•°æ®ï¼Œå¹¶æ˜¾ç¤ºåœ¨å‰ç«¯ç•Œé¢ã€‚

## å®ç°çš„åŠŸèƒ½

### âœ… è‡ªåŠ¨è§¦å‘

- **è§¦å‘æ¡ä»¶**: å½“ç”¨æˆ·æä¾›ä½ç½®ä¿¡æ¯ï¼ˆå¦‚ "501æœºä½"ï¼‰æ—¶
- **è§¦å‘æ—¶æœº**: åœ¨ `input_parser_node` ä¸­ï¼Œå®ä½“æå–å®Œæˆåè‡ªåŠ¨è°ƒç”¨
- **æŸ¥è¯¢æ–¹å¼**: ä½¿ç”¨ `location="æ¨è"` è‡ªåŠ¨é€‰æ‹©æœ€è¿‘çš„æ°”è±¡è§‚æµ‹ç‚¹

### âœ… æ•°æ®æµç¨‹

```
ç”¨æˆ·è¾“å…¥ï¼ˆåŒ…å«ä½ç½®ï¼‰
    â†“
input_parser_node (æå–å®ä½“)
    â†“
apply_auto_enrichment (å¹¶è¡ŒæŸ¥è¯¢)
    â”œâ”€ get_aircraft_info (èˆªç­ä¿¡æ¯)
    â”œâ”€ get_flight_plan (èˆªç­è®¡åˆ’)
    â”œâ”€ get_stand_location (ä½ç½®æ‹“æ‰‘)
    â””â”€ get_weather (æ°”è±¡ä¿¡æ¯) â† æ–°å¢
    â†“
æ›´æ–° state.weather
    â†“
build_context_summary (æ„å»ºä¸Šä¸‹æ–‡)
    â†“
æ˜¾ç¤ºæ°”è±¡ä¿¡æ¯ç»™ç”¨æˆ·
```

### âœ… ä½ç½®æ˜ å°„

ç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®äº‹ä»¶ä½ç½®é€‰æ‹©æœ€è¿‘çš„æ°”è±¡è§‚æµ‹ç‚¹ï¼š

| äº‹ä»¶ä½ç½® | æ°”è±¡è§‚æµ‹ç‚¹ | è¯´æ˜ |
|---------|----------|------|
| 501 | 05L | 05å·è·‘é“ä¸€ç«¯ |
| 601 | 06L | 06å·è·‘é“ä¸€ç«¯ |
| å…¶ä»– | NORTH | é»˜è®¤ä½¿ç”¨NORTHè§‚æµ‹ç‚¹ |

### âœ… æ˜¾ç¤ºå†…å®¹

æ°”è±¡ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨ä¸¤ä¸ªåœ°æ–¹ï¼š

1. **ä¸Šä¸‹æ–‡æ‘˜è¦ä¸­**ï¼š
   ```
   æ°”è±¡æ¡ä»¶: è§‚æµ‹ç‚¹: 05L, é£: 278Â° 2.3m/s
   ```

2. **å¢å¼ºä¿¡æ¯ä¸­**ï¼ˆåœ¨enrichment_observationï¼‰ï¼š
   ```
   ğŸŒ¤ï¸ æ°”è±¡ä¿¡æ¯: ã€05L æ°”è±¡ä¿¡æ¯ã€‘
   è§‚æµ‹æ—¶é—´: 23:59:58
   ğŸŒ¬ï¸  é£: 278Â° 2.3 m/s
      (è½»é£)
   ```

## æµ‹è¯•ç»“æœ

### ç«¯åˆ°ç«¯æµ‹è¯•

```
ç”¨æˆ·è¾“å…¥: 501æœºä½å‘ç”Ÿç‡ƒæ²¹æ³„æ¼ï¼Œå‘åŠ¨æœºè¿è½¬ä¸­ï¼Œè¿˜åœ¨æŒç»­æ¼æ²¹

âœ… ä½ç½®æå–: æˆåŠŸ (501)
âœ… æ°”è±¡æŸ¥è¯¢: æˆåŠŸ
   - è§‚æµ‹ç‚¹: 05L
   - è§‚æµ‹æ—¶é—´: 2026-01-06 23:59:58
   - é£: 278Â° 2.3 m/s
âœ… ä¸Šä¸‹æ–‡æ‘˜è¦: åŒ…å«æ°”è±¡ä¿¡æ¯
```

### ä¸åŒåœºæ™¯æµ‹è¯•

| ä½ç½® | æ˜ å°„åˆ° | æ°”è±¡æŸ¥è¯¢ | çŠ¶æ€ |
|-----|-------|---------|------|
| 501æœºä½ | 05L | âœ… æˆåŠŸ | 2.3 m/s |
| 601æœºä½ | 06L | âœ… æˆåŠŸ | æœ‰æ•°æ® |
| è·‘é“23R | NORTH | âœ… æˆåŠŸ | æœ‰æ•°æ® |
| æ— ä½ç½® | - | âœ… ä¸è§¦å‘ | æ­£ç¡® |

## ä»£ç ä¿®æ”¹

### 1. `agent/nodes/input_parser.py`

**æ–°å¢å‡½æ•°**ï¼š
```python
def _fetch_weather_info(state: Dict[str, Any]) -> Dict[str, Any]:
    """è·å–æ°”è±¡ä¿¡æ¯ï¼ˆè‡ªåŠ¨æŸ¥è¯¢æœ€æ–°æ•°æ®ï¼‰"""
    from tools.information.get_weather import GetWeatherTool
    tool = GetWeatherTool()
    return tool.execute(state, {"location": "æ¨è"})
```

**ä¿®æ”¹ `apply_auto_enrichment`**ï¼š
- åœ¨ç¬¬ä¸€é˜¶æ®µå¹¶è¡ŒæŸ¥è¯¢ä¸­æ·»åŠ æ°”è±¡æŸ¥è¯¢
- å°†æ°”è±¡ä¿¡æ¯æ·»åŠ åˆ° `updates["weather"]`
- å°†æ°”è±¡ä¿¡æ¯æ·»åŠ åˆ° `observations` ç”¨äºæ˜¾ç¤º

**ä¿®æ”¹ `input_parser_node`**ï¼š
- ä» enrichment ç»“æœä¸­æå– `weather_info`
- åœ¨è¿”å›å€¼ä¸­åŒ…å« `weather` å­—æ®µ

### 2. `agent/nodes/reasoning.py`

**ä¿®æ”¹ `build_context_summary`**ï¼š
- æ·»åŠ æ°”è±¡ä¿¡æ¯éƒ¨åˆ†
- æ ¼å¼åŒ–æ˜¾ç¤ºæ¸©åº¦ã€é£é€Ÿã€æ°”å‹ã€èƒ½è§åº¦ç­‰å­—æ®µ

## æ•°æ®ç‰¹æ€§

### ä½¿ç”¨å†å²æ•°æ®

- **æ•°æ®æº**: `data/processed/awos_weather_*.csv`
- **æ—¶é—´èŒƒå›´**: 2026-01-06 å…¨å¤©ï¼ˆ24å°æ—¶ï¼‰
- **æŸ¥è¯¢ç­–ç•¥**: ä½¿ç”¨æ•°æ®çš„æœ€æ–°æ—¶é—´ï¼ˆ23:59:58ï¼‰
- **åŸå› **: ç›®å‰åªæœ‰å†å²æ•°æ®ï¼Œæœªæ¥å¯æ¥å…¥å®æ—¶æ•°æ®æµ

### æ•°æ®å®Œæ•´æ€§

ä¸åŒä½ç½®çš„æ•°æ®å®Œæ•´æ€§ä¸åŒï¼š

| è§‚æµ‹ç‚¹ | é£æ•°æ® | æ¸©æ¹¿åº¦ | æ°”å‹ | èƒ½è§åº¦ |
|-------|-------|-------|------|--------|
| 05L | âœ… 40% | âœ… 28% | âŒ 0% | âŒ 0% |
| 06L | âœ… æœ‰ | âœ… æœ‰ | âœ… æœ‰ | âŒ æ—  |
| NORTH | âŒ æ—  | âŒ æ—  | âŒ æ—  | âœ… æœ‰ |
| SOUTH | âœ… æœ‰ | âŒ æ—  | âŒ æ—  | âŒ æ—  |

## ä½¿ç”¨ç¤ºä¾‹

### åœ¨Agentå¯¹è¯ä¸­

```
User: 501æœºä½å‘ç”Ÿç‡ƒæ²¹æ³„æ¼

Agent: ã€ç³»ç»Ÿè‡ªåŠ¨æŸ¥è¯¢ã€‘
ğŸŒ¤ï¸ æ°”è±¡ä¿¡æ¯: ã€05L æ°”è±¡ä¿¡æ¯ã€‘
è§‚æµ‹æ—¶é—´: 23:59:58
ğŸŒ¬ï¸  é£: 278Â° 2.3 m/s (è½»é£)

ã€ä¸Šä¸‹æ–‡æ‘˜è¦ã€‘
äº‹ä»¶ä¿¡æ¯: ä½ç½®: 501, æ²¹æ¶²ç±»å‹: FUEL
æ°”è±¡æ¡ä»¶: è§‚æµ‹ç‚¹: 05L, é£: 278Â° 2.3m/s

Agent: æˆ‘å·²æ”¶åˆ°æ‚¨æŠ¥å‘Šçš„äº‹ä»¶ã€‚å½“å‰æ°”è±¡æ¡ä»¶ä¸ºè¥¿åŒ—é£2.3m/sï¼ˆè½»é£ï¼‰...
```

### Pythonä»£ç ä¸­

```python
from agent.nodes.input_parser import input_parser_node

state = {
    "messages": [
        {"role": "user", "content": "501æœºä½ç‡ƒæ²¹æ³„æ¼"}
    ],
    "scenario_type": "oil_spill",
}

result = input_parser_node(state)

# è®¿é—®æ°”è±¡æ•°æ®
weather = result.get("weather", {})
print(f"è§‚æµ‹ç‚¹: {weather.get('location')}")
print(f"é£é€Ÿ: {weather.get('wind_speed')} m/s")
```

## æ€§èƒ½å½±å“

- **å¹¶è¡ŒæŸ¥è¯¢**: æ°”è±¡æŸ¥è¯¢ä¸å…¶ä»–ä¿¡æ¯æŸ¥è¯¢ï¼ˆèˆªç­ã€ä½ç½®ï¼‰å¹¶è¡Œæ‰§è¡Œ
- **æŸ¥è¯¢æ—¶é—´**: <100ms
- **æ€»è€—æ—¶**: ä¸å¢åŠ é¢å¤–æ—¶é—´ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰

## æ‰©å±•å¯èƒ½æ€§

### 1. æ¥å…¥å®æ—¶æ•°æ®

ä¿®æ”¹ `get_weather` å·¥å…·ï¼Œæ¥å…¥å®æ—¶AWOSæ•°æ®æµï¼š

```python
# ä»APIè·å–å®æ—¶æ•°æ®
response = requests.get(f"{AWOS_API_URL}/latest?location={location}")
realtime_data = response.json()
```

### 2. æ°”è±¡é¢„è­¦

æ·»åŠ æ°”è±¡é¢„è­¦åŠŸèƒ½ï¼š

```python
def check_weather_alerts(weather: dict) -> List[str]:
    alerts = []
    if weather.get('wind_speed', 0) > 10:
        alerts.append("âš ï¸ å¼ºé£è­¦å‘Š")
    # ...
    return alerts
```

### 3. æ°”è±¡å½±å“åˆ†æ

å°†æ°”è±¡æ¡ä»¶çº³å…¥é£é™©è¯„ä¼°ï¼š

```python
# åœ¨é£é™©è¯„ä¼°ä¸­è€ƒè™‘é£é€Ÿ
if weather.get('wind_speed', 0) > 5:
    risk_score += 10  # å¼ºé£å¢åŠ ç‡ƒæ²¹æ‰©æ•£é£é™©
```

## ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒä»£ç 
- `agent/nodes/input_parser.py` - æ·»åŠ è‡ªåŠ¨æ°”è±¡æŸ¥è¯¢
- `agent/nodes/reasoning.py` - æ·»åŠ æ°”è±¡ä¿¡æ¯æ˜¾ç¤º
- `tools/information/get_weather.py` - æ°”è±¡æŸ¥è¯¢å·¥å…·

### æµ‹è¯•æ–‡ä»¶
- `tests/integration/test_weather_e2e.py` - ç«¯åˆ°ç«¯æµ‹è¯•
- `tests/integration/test_weather_simple.py` - ç®€å•æµ‹è¯•
- `tests/integration/debug_weather_query.py` - è°ƒè¯•è„šæœ¬

### æ–‡æ¡£
- `docs/GET_WEATHER_TOOL.md` - å·¥å…·APIæ–‡æ¡£
- `docs/AWOS_WEATHER_PROCESSING.md` - æ•°æ®å¤„ç†æŒ‡å—
- `docs/AUTO_WEATHER_INTEGRATION.md` - æœ¬æ–‡æ¡£

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ°”è±¡ä¿¡æ¯æœªæ˜¾ç¤º

**æ£€æŸ¥1**: æ•°æ®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
```bash
ls data/processed/awos_weather_*.csv
```

**æ£€æŸ¥2**: è¿è¡Œæ•°æ®æå–
```bash
python scripts/data_processing/extract_awos_weather.py
```

**æ£€æŸ¥3**: æŸ¥çœ‹è°ƒè¯•æ—¥å¿—
```bash
python tests/integration/debug_weather_query.py
```

### é—®é¢˜ï¼šä½ç½®æ˜ å°„ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ**ï¼šä¿®æ”¹ `get_weather.py` ä¸­çš„ä½ç½®æ˜ å°„

```python
position_to_sensor = {
    "501": "05L",
    "601": "06L",
    "701": "07L",  # æ·»åŠ æ–°æ˜ å°„
    # ...
}
```

## Bug ä¿®å¤è®°å½•

### 2026-01-13: ä¿®å¤ enrichment_observation æœªè¿”å›çš„é—®é¢˜

**é—®é¢˜**: è™½ç„¶æ°”è±¡æŸ¥è¯¢æˆåŠŸä¸”æ•°æ®å·²æ·»åŠ åˆ° `state.weather`ï¼Œä½† `enrichment_observation` å­—æ®µæœªåŒ…å«æ°”è±¡ä¿¡æ¯ã€‚

**åŸå› **: åœ¨ `input_parser_node()` ä¸­ï¼Œè™½ç„¶ `apply_auto_enrichment()` è¿”å›äº† `enrichment_observation`ï¼Œä½†è¯¥å­—æ®µæœªè¢«æå–å’Œè¿”å›ã€‚

**ä¿®å¤**:
1. åœ¨ `input_parser_node()` ä¸­æ·»åŠ æå–: `enrichment_observation = enrichment.get("enrichment_observation", "")`
2. åœ¨è¿”å›å€¼ä¸­æ·»åŠ : `**({"enrichment_observation": enrichment_observation} if enrichment_observation else {})`

**å½±å“**: ç°åœ¨æ°”è±¡ä¿¡æ¯ä¼šåŒæ—¶æ˜¾ç¤ºåœ¨ï¼š
- âœ… `state.weather` (ç»“æ„åŒ–æ•°æ®)
- âœ… `enrichment_observation` (æ ¼å¼åŒ–æ–‡æœ¬ï¼ŒåŒ…å«ğŸŒ¤ï¸å›¾æ ‡)
- âœ… `build_context_summary()` (ä¸Šä¸‹æ–‡æ‘˜è¦)

## æ€»ç»“

âœ… **åŠŸèƒ½å®Œæ•´**: è‡ªåŠ¨è§¦å‘ã€æŸ¥è¯¢ã€æ˜¾ç¤º
âœ… **æµ‹è¯•é€šè¿‡**: ç«¯åˆ°ç«¯æµ‹è¯•å…¨éƒ¨é€šè¿‡
âœ… **æ€§èƒ½è‰¯å¥½**: å¹¶è¡ŒæŸ¥è¯¢ï¼Œæ— æ€§èƒ½æŸå¤±
âœ… **å¯æ‰©å±•**: æ”¯æŒå®æ—¶æ•°æ®æ¥å…¥ã€é¢„è­¦ã€å½±å“åˆ†æ
âœ… **Bugä¿®å¤**: enrichment_observation æ­£ç¡®è¿”å›æ°”è±¡ä¿¡æ¯

**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
**æ—¥æœŸ**: 2026-01-13
