# FSM 状态定义
# 版本: 1.0
# 描述: 鸟击/疑似鸟击应急处置流程状态机定义

fsm_states:
  # 初始状态
  - id: INIT
    name: 初始状态
    description: "接收鸟击/疑似鸟击报告，等待信息收集"
    order: 0

  # 风险评估阶段
  - id: P1_RISK_ASSESS
    name: 风险评估
    description: "确认事件类型、位置与影响部位，评估风险"
    order: 1
    preconditions:
      - checklist.flight_no
      - checklist.position
      - checklist.event_type
      - checklist.affected_part
      - checklist.current_status
      - checklist.crew_request

  # 立即控制阶段
  - id: P2_IMMEDIATE_CONTROL
    name: 立即控制
    description: "执行初始安全控制措施与通知"
    order: 2
    preconditions:
      - mandatory.risk_assessed
    triggers:
      - condition:
          incident.current_status: 火警
        action: notify_department
        params:
          department: 消防
          priority: immediate
        description: "火警时强制通知消防"
      - condition:
          incident.affected_part: 发动机
        action: notify_department
        params:
          department: 机务
          priority: high
        description: "发动机受损时强制通知机务"

  # 资源调度阶段
  - id: P3_RESOURCE_DISPATCH
    name: 资源调度
    description: "调度机务检查与现场保障资源"
    order: 3

  # 区域隔离阶段
  - id: P4_AREA_ISOLATION
    name: 区域隔离
    description: "评估影响区域，必要时隔离跑道/滑行道"
    order: 4
    triggers:
      - condition:
          incident.position: 跑道
        action: notify_department
        params:
          department: 塔台
          priority: high
        description: "位置涉及跑道时强制通知塔台"

  # 现场处置阶段
  - id: P5_CLEANUP
    name: 现场处置
    description: "安排现场清理或残留检查"
    order: 5

  # 结果确认阶段
  - id: P6_VERIFICATION
    name: 结果确认
    description: "确认检查/清理结果"
    order: 6

  # 运行恢复阶段
  - id: P7_RECOVERY
    name: 运行恢复
    description: "恢复受影响区域运行"
    order: 7
    triggers:
      - condition:
          notifications_sent: not_empty
        action: notify_department
        params:
          department: 塔台
          priority: normal
        description: "恢复后通知塔台"

  # 关闭与报告阶段
  - id: P8_CLOSE
    name: 关闭与报告
    description: "生成报告，完成事件处置"
    order: 8
    preconditions:
      - checklist.flight_no
      - checklist.position
      - checklist.event_type
      - checklist.affected_part
      - checklist.current_status
      - checklist.crew_request
      - mandatory.risk_assessed

  # 完成状态
  - id: COMPLETED
    name: 完成
    description: "事件处置完成"
    order: 9
    is_terminal: true

# 状态转换规则
transitions:
  - from: INIT
    to: P1_RISK_ASSESS
    trigger: start_risk_assessment
    guard: "event_type is not None and position is not None"

  - from: P1_RISK_ASSESS
    to: P2_IMMEDIATE_CONTROL
    trigger: complete_risk_assessment
    guard: "risk.level is not None"

  - from: P2_IMMEDIATE_CONTROL
    to: P3_RESOURCE_DISPATCH
    trigger: complete_controls
    guard: "maintenance_notified or fire_dept_notified"

  - from: P3_RESOURCE_DISPATCH
    to: P4_AREA_ISOLATION
    trigger: resources_ready
    guard: "notifications_sent not_empty"

  - from: P4_AREA_ISOLATION
    to: P5_CLEANUP
    trigger: area_isolated
    guard: "atc_notified or incident.position not_contains 跑道"

  - from: P5_CLEANUP
    to: P6_VERIFICATION
    trigger: cleanup_complete
    guard: "notifications_sent not_empty"

  - from: P6_VERIFICATION
    to: P7_RECOVERY
    trigger: verification_passed
    guard: "notifications_sent not_empty"

  - from: P7_RECOVERY
    to: P8_CLOSE
    trigger: recovery_complete
    guard: "notifications_sent not_empty"

  - from: P8_CLOSE
    to: COMPLETED
    trigger: finish
    guard: "report_generated"
